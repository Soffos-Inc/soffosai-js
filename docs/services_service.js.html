<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: services/service.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: services/service.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { SOFFOS_SERVICE_URL, FORM_DATA_REQUIRED } from "../../common/index.js";
import { apiKey } from "../../../../soffosai/src/app.js";
import {get_serviceio_datatype, get_userinput_datatype, isDictObject} from "./../../utils/type_classifications.js"

const visit_docs_message = "Kindly visit https://platform.soffos.ai/playground/docs#/ for guidance.";
const input_structure_message = "To learn what the input dictionary should look like, access it by &lt;your_service_instance>.input_structure";


/**
 * given a uuid string without dashes, convert it to standard form
 * @param {string} uuid 
 * @returns {string}
 */
function formatUuid(uuid) {
  const formattedUuid = [uuid.slice(0, 8), uuid.slice(8, 12), uuid.slice(12, 16), uuid.slice(16, 20), uuid.slice(20)].join("-");
  return formattedUuid;
}

/**
 * Checks if a string is a valid UUID string
 * @param {string} uuidString 
 * @returns {boolean}
 */
function isValidUuid(uuidString) {
  if (typeof uuidString === "function") {
    return true;
  }
  let formattedUuid;
  if (!uuidString.includes("-")) {
    formattedUuid = formatUuid(uuidString);
  } else {
    formattedUuid = uuidString;
  }
  const regex = /^[a-f0-9]{8}-[a-f0-9]{4}-[1-5][a-f0-9]{3}-[89ab][a-f0-9]{3}-[a-f0-9]{12}$/i;
  return regex.test(formattedUuid);
}


/**
 * Base service class for all Soffos Services
 */
class SoffosAIService {
  /**
   * @param {string} service - The name of the Soffos Service
   * @param {Object} kwargs  - holds additional properties for the Service like apiKey.
   */
    constructor(service, kwargs = {}) {
      const apikey = kwargs.apiKey;
      this.headers = {
        "x-api-key": apikey || apiKey,
      };
      this._apikey = this.headers["x-api-key"];
      this._service = service;
      // In a pipeline, some payload properties are constants and should be related to the Service's instance
      this._payload = {};
    }

    /**
     * These are the valid fields of the src dictionary for this service. Take note that some of the fields should not exist at the same time.
     * To view fields that cannot co-exist, access the 'choose_one' property.
     */
    get_input_structure() {
        return this._serviceio.input_structure;
      }

    /**
     * Prefetch validation algorithm before the API is actually accessed. Saves time and credits.
     * @param {object} payload         - The data that will be sent to the Soffos API for interpretation and response
     * @returns {Array&lt;boolean,Array>} - The first element of the return value is the status of the validation: true if valid else false. 
     *                                   The second element is the list of errors. null if there are no errors
     */
    async validatePayload(payload) {
        
        if (!isDictObject(payload)) {
          throw new TypeError("payload should be an object");
        }

        // Check for missing arguments
        const userFromSrc = payload.user;
        if (!userFromSrc) {
          return [false, `${this._service}: user key is required in the payload`];
        }
      
        if (this._serviceio.required_input_fields.length > 0) {
          const missingRequirements = this._serviceio.required_input_fields.filter(
            (required) => !(required in payload)
          );

          if (missingRequirements.length > 0) {
            
            return [
              false,
              `${this._service}: Please provide ${missingRequirements} on your payload. ${visit_docs_message}. ${input_structure_message}`,
            ];
          }
        }

        let groupErrors = [];

        let special_validation = this._serviceio.special_validation(payload);
        let special_validation_passed = special_validation[0];
        let special_validation_error_message = special_validation[1];
        if (!special_validation_passed) {
          groupErrors.push(special_validation_error_message);
        }

        if (this._serviceio.require_one_of_choices.length > 0) {
          for (const group of this._serviceio.require_one_of_choices) {
            const foundChoices = group.filter((choice) => choice in payload);
            if (foundChoices.length === 0) {
              groupErrors.push(
                `${this._service}: Please provide one of these values on your payload: ${group}`
              );
            } else if (foundChoices.length > 1) {
              groupErrors.push(
                `${this._service}: Please only include one of these values: ${group}`
              );
            }
          }
        
        if (groupErrors.length > 0) {
          return [false, groupErrors];
        }
        }
      
        // Check if payload has proper types
        const inputStructure = this._serviceio.input_structure;
        const valueErrors = [];
        for (const [key, value] of Object.entries(payload)) {
          if (key in inputStructure &amp;&amp; key != 'file') {
            const serviceioType = get_serviceio_datatype(inputStructure[key]);
            const inputType = get_userinput_datatype(value);
            if (inputType !== serviceioType) {
              const wrongType = value instanceof Object ? typeof value : typeof value;
              valueErrors.push(`${key} requires ${inputType} but ${wrongType} is provided.`);
            }
          }
        }
      
        if (valueErrors.length > 0) {
          return [false, valueErrors];
        }
      
        if ("document_ids" in payload) {
          const documentIds = payload.document_ids;
          if (Array.isArray(documentIds)) {
            for (const _id of documentIds) {
              const validUuid = isValidUuid(_id);
              if (!validUuid) {
                return [false, `${_id} is an invalid document_id`];
              }
            }
          }
        }
      
        return [true, null];
    }
    
    /**
     * Prepare the JSON or form data input of the service
     * Will be used when there is a special handling needed for an element of the payload
     */
    getData(payload) {
        const requestData = {};
        for (const [key, value] of Object.entries(payload)) {
            requestData[key] = value;
        }
      
        return requestData;
    }

    /**
     * Based on the knowledge/context, Soffos AI will now give you the data you need
     * @param {object} payload - the payload to be supplied into the fetch request
     */
    async getResponse(payload = {}, kwargs={}) {
        // the apiKey can also be a part of the payload.  This is usefull when defining apiKey in the pipeline.
        if ("apiKey" in payload) {
          this._apikey = payload.apiKey;
          delete payload.apiKey;
        }
        const [allowInput, message] = await this.validatePayload(payload);
        if ("question" in payload) {
          // The API receives the question as "message"
          payload["message"] = payload["question"];
        }
      
        if (!allowInput) {
          throw new Error(message);
        }
      
        if (!this._service) {
          throw new Error("Please provide the service you need from Soffos AI.");
        }
        
        const data = this.getData(payload);
        // dispatch soffosai:on-request event
        const onRequestEvent = new CustomEvent("soffosai:on-request", {detail: data});
        // window.dispatchEvent(onRequestEvent);

        // Call the API
        let response;
        let response_data;
        const url = SOFFOS_SERVICE_URL + this._service + "/";
        let headers
        if (!FORM_DATA_REQUIRED.includes(this._service)) {
          headers = {
            "content-type": "application/json",
            "x-api-key": this._apikey
          };
          try {
            response = await fetch(
              url, 
              {
                headers: headers,
                method: 'POST',
                body: JSON.stringify(data)
              }
            );
          } catch (error){
            // dispatch soffosai:on-service-error event
            const onServiceErorrEvent = new CustomEvent("soffosai:on-service-error", {detail: error});
            // window.dispatchEvent(onServiceErorrEvent);
            return {
              error: error,
              response: response
            }
          }
          
        } else {
          const formData = new FormData();
          Object.keys(data).forEach(key=>{
            formData.append(key, data[key]);
          })
          // let headers = formData.getHeaders();
          headers = {};
          headers["x-api-key"] = this._apikey;
          try {
            response = await fetch(
              url,
              {
                headers: headers,
                method: 'POST',
                body: formData
              }
            );
          } catch (error) {
            // dispatch soffosai:on-service-error event
            const onServiceErorrEvent = new CustomEvent("soffosai:on-service-error", {detail: error});
            // window.dispatchEvent(onServiceErorrEvent);
            return {
              error: error,
              response: response
            }
          }
        }
        response_data = await response.json();
        // dispatch soffosai:on-response event
        const responseEvent = new CustomEvent("soffosai:on-response", {detail: response_data});
        // window.dispatchEvent(responseEvent);
        return response_data;

    }
    
    /**
     * Call the service
     * @param {object} kwargs 
     * @returns {object}
     */
    call(payload, kwargs = {}) {
        return this.getResponse(payload, kwargs);
    }
      
    toString() {
        return this._service;
    }
    
    provideOutputType() {
        throw new Error('Abstract method provideOutputType must be implemented');
    }
      
    provideSourceType() {
        throw new Error('Abstract method provideSourceType must be implemented');
    }
    
    getDefaultOutputKey() {
        throw new Error('Abstract method getDefaultOutputKey must be implemented');
    }
      
}

export { isValidUuid, SoffosAIService}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AmbiguityDetectionService.html">AmbiguityDetectionService</a></li><li><a href="AnswerScoringService.html">AnswerScoringService</a></li><li><a href="ContradictionDetectionService.html">ContradictionDetectionService</a></li><li><a href="DocumentsDeleteService.html">DocumentsDeleteService</a></li><li><a href="DocumentsIngestService.html">DocumentsIngestService</a></li><li><a href="DocumentsSearchService.html">DocumentsSearchService</a></li><li><a href="EmailAnalysisService.html">EmailAnalysisService</a></li><li><a href="EmotionDetectionService.html">EmotionDetectionService</a></li><li><a href="FileConverterService.html">FileConverterService</a></li><li><a href="LanguageDetectionService.html">LanguageDetectionService</a></li><li><a href="LetsDiscussCreateService.html">LetsDiscussCreateService</a></li><li><a href="LetsDiscussDeleteService.html">LetsDiscussDeleteService</a></li><li><a href="LetsDiscussRetrieveService.html">LetsDiscussRetrieveService</a></li><li><a href="LetsDiscussService.html">LetsDiscussService</a></li><li><a href="LogicalErrorDetectionService.html">LogicalErrorDetectionService</a></li><li><a href="MicrolessonService.html">MicrolessonService</a></li><li><a href="NamedEntityRecognitionService.html">NamedEntityRecognitionService</a></li><li><a href="Node.html">Node</a></li><li><a href="ParaphraseService.html">ParaphraseService</a></li><li><a href="Pipeline.html">Pipeline</a></li><li><a href="ProfanityService.html">ProfanityService</a></li><li><a href="QuestionAndAnswerGenerationService.html">QuestionAndAnswerGenerationService</a></li><li><a href="QuestionAnsweringService.html">QuestionAnsweringService</a></li><li><a href="ReviewTaggerService.html">ReviewTaggerService</a></li><li><a href="SentimentAnalysisService.html">SentimentAnalysisService</a></li><li><a href="SimplifyService.html">SimplifyService</a></li><li><a href="SoffosAIService.html">SoffosAIService</a></li><li><a href="SoffosNodes.AmbiguityDetectionNode.html">AmbiguityDetectionNode</a></li><li><a href="SoffosNodes.AnswerScoringNode.html">AnswerScoringNode</a></li><li><a href="SoffosNodes.ContradictionDetectionNode.html">ContradictionDetectionNode</a></li><li><a href="SoffosNodes.DocumentsDeleteNode.html">DocumentsDeleteNode</a></li><li><a href="SoffosNodes.DocumentsIngestNode.html">DocumentsIngestNode</a></li><li><a href="SoffosNodes.DocumentsSearchNode.html">DocumentsSearchNode</a></li><li><a href="SoffosNodes.EmailAnalysisNode.html">EmailAnalysisNode</a></li><li><a href="SoffosNodes.EmotionDetectionNode.html">EmotionDetectionNode</a></li><li><a href="SoffosNodes.FileConverterNode.html">FileConverterNode</a></li><li><a href="SoffosNodes.LanguageDetectionNode.html">LanguageDetectionNode</a></li><li><a href="SoffosNodes.LetsDiscussCreateNode.html">LetsDiscussCreateNode</a></li><li><a href="SoffosNodes.LetsDiscussDeleteNode.html">LetsDiscussDeleteNode</a></li><li><a href="SoffosNodes.LetsDiscussNode.html">LetsDiscussNode</a></li><li><a href="SoffosNodes.LetsDiscussRetrieveNode.html">LetsDiscussRetrieveNode</a></li><li><a href="SoffosNodes.LogicalErrorDetectionNode.html">LogicalErrorDetectionNode</a></li><li><a href="SoffosNodes.MicrolessonNode.html">MicrolessonNode</a></li><li><a href="SoffosNodes.NamedEntityRecognitionNode.html">NamedEntityRecognitionNode</a></li><li><a href="SoffosNodes.ParaphraseNode.html">ParaphraseNode</a></li><li><a href="SoffosNodes.ProfanityNode.html">ProfanityNode</a></li><li><a href="SoffosNodes.QuestionAndAnswerGenerationNode.html">QuestionAndAnswerGenerationNode</a></li><li><a href="SoffosNodes.QuestionAnsweringNode.html">QuestionAnsweringNode</a></li><li><a href="SoffosNodes.ReviewTaggerNode.html">ReviewTaggerNode</a></li><li><a href="SoffosNodes.SentimentAnalysisNode.html">SentimentAnalysisNode</a></li><li><a href="SoffosNodes.SimplifyNode.html">SimplifyNode</a></li><li><a href="SoffosNodes.SummarizationNode.html">SummarizationNode</a></li><li><a href="SoffosNodes.TableGeneratorNode.html">TableGeneratorNode</a></li><li><a href="SoffosNodes.TagGenerationNode.html">TagGenerationNode</a></li><li><a href="SoffosNodes.TranscriptCorrectionIO.html">TranscriptCorrectionIO</a></li><li><a href="SoffosPipelines.AskADocumentPipeline.html">AskADocumentPipeline</a></li><li><a href="SoffosPipelines.FileIngestPipeline.html">FileIngestPipeline</a></li><li><a href="SummarizationService.html">SummarizationService</a></li><li><a href="TableGeneratorService.html">TableGeneratorService</a></li><li><a href="TagGenerationService.html">TagGenerationService</a></li><li><a href="TranscriptCorrectionService.html">TranscriptCorrectionService</a></li></ul><h3>Global</h3><ul><li><a href="global.html#formatUuid">formatUuid</a></li><li><a href="global.html#getContent">getContent</a></li><li><a href="global.html#isValidUuid">isValidUuid</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.2</a> on Thu Sep 07 2023 18:26:54 GMT+0800 (Singapore Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
